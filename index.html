<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</title>

<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{--primary:#1556d1;--danger:#ef5753;--ok:#137333;--fg:#111;--muted:#666;--bg:#f6f7fb;--card:#fff}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif;line-height:1.6;margin:0}
  .wrap{max-width:880px;margin:0 auto;padding:20px}
  .card{background:var(--card);border-radius:18px;box-shadow:0 2px 14px rgba(0,0,0,.06);padding:20px}
  h1{font-size:22px;margin:0 0 8px}
  label{display:block;font-weight:900;margin:14px 0 6px}
  input[type="text"]{width:100%;padding:14px 16px;border:1px solid #ddd;border-radius:14px;font-size:16px}

  .btn{appearance:none;border:0;border-radius:14px;padding:14px 16px;font-weight:900;font-size:16px;cursor:pointer;transition:transform .02s ease}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  .btn-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
  .btn-bar{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}

  .msg{padding:12px 14px;border-radius:12px;margin:10px 0;font-size:16px}
  .msg-ok{background:#e9f5ee;color:var(--ok);border:1px solid #bfe5cd}
  .msg-bad{background:#fdecec;color:#a12121;border:1px solid #f3c3c0}
  .msg-info{background:#eef3ff;color:#274291;border:1px solid #cfdcff}

  .mini{font-size:12px;color:var(--muted);margin-top:4px}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:10px}
  .thumb{background:#fafafa;border:1px solid #eee;border-radius:14px;overflow:hidden}
  .thumb img{width:100%;height:120px;object-fit:cover;display:block;background:#fff}
  .thumb .meta{padding:8px 10px;font-size:14px}
  .thumb .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .remove{background:#ffe7e7;color:#a12121;border:0;border-radius:10px;padding:6px 8px;font-weight:900;cursor:pointer}

  .progress{height:10px;background:#e8eefc;border-radius:999px;overflow:hidden;margin:10px 0 0}
  .bar{width:40%;height:100%;background:var(--primary);animation:indef 1.2s infinite}
  @keyframes indef{0%{transform:translateX(-60%)}100%{transform:translateX(160%)}}

  /* é€ä¿¡å…ˆ */
  .dest-box{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:8px 0 6px}
  .dest-item{background:#f2f6ff;border:2px solid #d9e4ff;border-radius:16px;padding:14px;display:flex;gap:10px;align-items:center;cursor:pointer;user-select:none}
  .dest-item input{width:22px;height:22px}
  .dest-item.active{border-color:#1556d1;background:#eaf0ff}
  .dest-title{font-weight:900;font-size:18px}

  /* ã‚«ãƒ¡ãƒ© */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal.show{display:flex}
  .cam{background:#000;width:100%;max-width:1000px;color:#fff;display:flex;flex-direction:column;height:100svh}
  .cam video{flex:1 1 auto;width:100%;object-fit:cover}
  .cam .controls{display:flex;gap:10px;justify-content:space-between;padding:12px;background:rgba(0,0,0,.6)}
  .cam .btn{flex:1}

  /* æ’®å½±æšæ•°ãƒãƒƒã‚¸ã®è¦‹ãŸç›®ã‚’è¿½åŠ  */
  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:22px;
    height:22px;
    padding:0 7px;
    margin-left:8px;
    border-radius:999px;
    background:#fff;
    color:var(--primary);
    font-weight:900;
    font-size:13px;
    box-shadow:0 1px 4px rgba(0,0,0,.15);
  }

  /* ===== å…¨ç”»é¢ãƒ­ãƒƒã‚¯ ===== */
  .blocker{
    position:fixed; inset:0;
    background:rgba(0,0,0,.72);
    display:flex; align-items:center; justify-content:center;
    z-index:99999;
    padding:20px;
  }
  .blocker[hidden]{display:none}
  .blockerCard{
    width:min(560px, 100%);
    background:#fff;
    border-radius:18px;
    padding:18px;
    box-shadow:0 12px 40px rgba(0,0,0,.35);
  }
  /* ===== å…¨ç”»é¢ãƒ­ãƒƒã‚¯ï¼šä¸Šæ®µï¼ˆã‚¹ãƒ”ãƒŠãƒ¼ï¼‹ãƒ†ã‚­ã‚¹ãƒˆï¼‰å®Œå…¨ç‰ˆ ===== */
  .blkTop{
    display:flex;
    gap:14px;
    align-items:center;

    /* ç”»é¢ãŒç‹­ãã¦ã‚‚å´©ã‚Œã«ããã™ã‚‹ */
    flex-wrap:nowrap;
    min-width:0;          /* flexã®å­ãŒã¯ã¿å‡ºã™ã®ã‚’é˜²ãåœŸå° */
  }
  /* ãƒ†ã‚­ã‚¹ãƒˆå´ãŒæ¨ªã«è©°ã¾ã£ã¦ã‚‚ã€ŒæŠ˜ã‚Šè¿”ã—ã¦åã¾ã‚‹ã€ */
  .blkText{
    min-width:0;          /* â˜…ã“ã‚ŒãŒç„¡ã„ã¨çœç•¥/ã¯ã¿å‡ºã—äº‹æ•…ãŒèµ·ãã‚‹ */
    flex:1 1 auto;
  }

  /* ã‚¿ã‚¤ãƒˆãƒ«/ã‚µãƒ–ã®æŠ˜ã‚Šè¿”ã—ãƒ»è¦‹åˆ‡ã‚Œæœ€é©åŒ– */
  .blkTitle{
    font-weight:900;
    font-size:22px;
    line-height:1.2;
    word-break:break-word;
  }
  .blkSub{
    margin-top:2px;
    color:#444;
    font-weight:700;
    line-height:1.25;
    word-break:break-word;
  }
  /* ã‚¹ãƒ”ãƒŠãƒ¼ã¯ã€Œçµ¶å¯¾ã«æ½°ã‚Œãªã„ã€ */
  .spinner{
    width:44px;
    height:44px;
    min-width:44px;      /* â˜…è¿½åŠ  */
    min-height:44px;     /* â˜…è¿½åŠ  */
    flex:0 0 44px;       /* â˜…è¿½åŠ ï¼ˆflexã§æ½°ã‚Œãªã„ï¼‰ */
    aspect-ratio:1 / 1;  /* â˜…è¿½åŠ ï¼ˆä¿é™ºï¼‰ */
    border-radius:50%;
    border:5px solid rgba(21,86,209,.25);
    border-top-color:rgba(21,86,209,1);
    animation:spin 0.9s linear infinite;
    /* è¿½åŠ ï¼ˆiOSã®æç”»æ½°ã‚Œå¯¾ç­–ï¼‰ */
    transform-origin: center;
    -webkit-transform: translateZ(0);
    will-change: transform;    
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  /* å°ã•ã„ç”»é¢ã§ã¯å°‘ã—è©°ã‚ã‚‹ï¼ˆä»»æ„ã ã‘ã©å®Ÿç”¨çš„ï¼‰ */
  @media (max-width: 380px){
    .blkTitle{ font-size:20px; }
    .spinner{
      width:40px; height:40px;
      min-width:40px; min-height:40px;
      flex:0 0 40px;
      border-width:5px;
    }
  }
  .blkProgress{margin-top:14px}
  .blkProgText{font-weight:900; margin-bottom:10px}
  .blkBar{height:14px; background:#e8eefc; border-radius:999px; overflow:hidden}
  .blkBarInner{height:100%; width:0% ; background:var(--primary); transition:width .25s ease}
  .blkMini{margin-top:8px; color:#666; font-size:13px}

  .blkFocus{
    position:absolute; left:-9999px; width:1px; height:1px; opacity:0;
  }

</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>

    <form id="f" autocomplete="off" novalidate>
      <label>é€ä¿¡å…ˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div id="destBox" class="dest-box"></div>
      <div class="mini">â€» é¸ã‚“ã éƒ¨ç½²ã™ã¹ã¦ã«åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>

      <label>åˆ©ç”¨è€…åãƒ»CMå ç­‰ï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="note" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒï¼CMåï¼äº‹æ¥­æ‰€å ãªã©" />

      <label>å†™çœŸãƒ»PDFï¼ˆæœ€å¤§ 5 æšï¼‰</label>
      <div class="btn-row">
        <button type="button" class="btn btn-primary" id="pickBtn">ğŸ“ ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸ã¶</button>
        <button type="button" class="btn btn-primary" id="camBtn">
          ğŸ“¸ å†™çœŸã‚’æ’®ã‚‹ <span id="camBadge" class="badge" style="display:none"></span>
        </button>
      </div>
      <div class="mini">â€» 1ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šé™ï¼š20MBï¼ˆjpeg / png / pdfï¼‰</div>

      <input id="pick" type="file" accept="image/jpeg,image/png,application/pdf" multiple style="display:none">
      <input id="cameraFile" type="file" accept="image/*" capture="environment" multiple
            style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0">

      <div class="btn-bar">
        <button type="button" class="btn btn-danger" id="clearBtn">âœ– ã™ã¹ã¦å‰Šé™¤</button>
      </div>

      <div id="precheck" class="msg msg-info" role="status">æº–å‚™ä¸­â€¦</div>
      <div class="thumbs" id="thumbs"></div>

      <div class="btn-bar" style="margin-top:14px">
        <button class="btn btn-primary" id="sendBtn" type="submit" disabled>â¬† é€ä¿¡ã™ã‚‹</button>
      </div>

      <div id="sending" class="msg msg-info" style="display:none">
        â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚
        <div id="progText" class="mini" style="margin-top:6px"></div>
        <div class="progress"><div class="bar"></div></div>
      </div>

      <div id="done" class="msg msg-ok" style="display:none">
        <strong>âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ</strong>
      </div>
    </form>
  </div>
</div>

<!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="camModal" class="modal" aria-hidden="true">
  <div class="cam" role="dialog" aria-label="ã‚«ãƒ¡ãƒ©ã§æ’®å½±">
    <video id="camVideo" autoplay playsinline></video>
    <div class="controls">
      <button type="button" class="btn" id="camClose">é–‰ã˜ã‚‹</button>
      <button type="button" class="btn btn-primary" id="camShot">
        æ’®å½±ã—ã¦è¿½åŠ  <span id="shotBadge" class="badge" style="display:none"></span>
      </button>
    </div>
  </div>
</div>

<!-- é€ä¿¡ä¸­ãƒ­ãƒƒã‚¯ï¼ˆå…¨ç”»é¢ï¼‰ -->
<div id="blocker" class="blocker" hidden aria-hidden="true">
  <div class="blockerCard" role="alertdialog" aria-modal="true" aria-labelledby="blkTitle">
    <div class="blkTop">
      <div class="spinner" aria-hidden="true"></div>
      <div class="blkText">
        <div id="blkTitle" class="blkTitle">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™</div>
        <div class="blkSub">ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ï¼ˆé–‰ã˜ã‚‹ã¨å¤±æ•—ã—ã¾ã™ï¼‰</div>
      </div>
    </div>

    <div class="blkProgress">
      <div id="blkProgText" class="blkProgText">é€ä¿¡æº–å‚™ä¸­â€¦</div>
      <div class="blkBar"><div id="blkBarInner" class="blkBarInner"></div></div>
      <div class="blkMini">é›»æ³¢ãŒæ‚ªã„ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚</div>
    </div>

    <!-- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å›ºå®šç”¨ï¼ˆè¦–ç·š/æ“ä½œã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã«å¯„ã›ã‚‹ï¼‰ -->
    <button id="blkFocus" class="blkFocus" type="button">é€ä¿¡ä¸­</button>
  </div>
</div>

<script>
/* ====== ã‚ãªãŸã® /execï¼ˆåŸ‹ã‚è¾¼ã¿æ¸ˆã¿ï¼‰ ====== */
const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyW3w7ZAEZfWEOOrqg_iXKm89gzBO9Cj35bB_Dssy2Yt26QuESPN3ws_izF2cr2eLkysA/exec';

const MAX_FILES = 5;
const MAX_BYTES = 20*1024*1024;
const ALLOW_MIME = ['image/jpeg','image/png','image/heic','image/heif','application/pdf'];

const KEY_STORAGE = 'upload_key_v1';
const queue = [];
const $ = s => document.querySelector(s);

const destBox = $('#destBox');
const pickInput = $('#pick');
const cameraFile = $('#cameraFile');
const thumbs = $('#thumbs');
const precheck = $('#precheck');
const sendBtn = $('#sendBtn');
const sending = $('#sending');
const progText = $('#progText');
const doneBox = $('#done');

const blocker     = $('#blocker');
const blkProgText = $('#blkProgText');
const blkBarInner = $('#blkBarInner');
const blkFocus    = $('#blkFocus');

let uploading = false;
let wakeLock = null;
let popGuardOn = false;

// é€ä¿¡ä¸­ï¼šç”»é¢ã‚¹ãƒªãƒ¼ãƒ—æŠ‘æ­¢ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
async function requestWakeLock_(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', ()=>{ wakeLock=null; });
    }
  }catch(_){}
}
async function releaseWakeLock_(){
  try{ if(wakeLock) await wakeLock.release(); }catch(_){}
  wakeLock=null;
}

// æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå±¥æ­´æˆ»ã‚Šï¼‰æŠ‘æ­¢
function enablePopGuard_(){
  if(popGuardOn) return;
  popGuardOn = true;
  try{ history.pushState({uploading:1}, '', location.href); }catch(_){}
  window.addEventListener('popstate', onPopState_);
}
function disablePopGuard_(){
  if(!popGuardOn) return;
  popGuardOn = false;
  window.removeEventListener('popstate', onPopState_);
}
function onPopState_(){
  if(!uploading) return;
  try{ history.pushState({uploading:1}, '', location.href); }catch(_){}
  alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã¯æˆ»ã‚Œã¾ã›ã‚“ã€‚å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚');
}

// ã‚¿ãƒ–/æ›´æ–°/é–‰ã˜ã‚‹è­¦å‘Šï¼ˆiPhoneã¯åŠ¹ãã«ãã„ãŒã€PCã¯åŠ¹ãï¼‰
window.addEventListener('beforeunload', (e)=>{
  if(!uploading) return;
  e.preventDefault();
  e.returnValue = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚é–‰ã˜ã‚‹ã¨é€ä¿¡ãŒå¤±æ•—ã—ã¾ã™ã€‚';
  return e.returnValue;
});

function showBlocker_(total, index){
  blocker.hidden = false;
  blocker.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¼·åˆ¶ï¼ˆè¦–ç·šèª˜å° + å¤‰ãªæ“ä½œã‚’æ¸›ã‚‰ã™ï¼‰
  try{ blkFocus.focus({preventScroll:true}); }catch(_){}
  updateBlockerProgress_(total, index);
}
function hideBlocker_(){
  blocker.hidden = true;
  blocker.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
}
function updateBlockerProgress_(total, done){
  const d = Math.max(0, Math.min(done, total));
  const pct = total ? Math.round((d/total)*100) : 0;
  blkProgText.textContent = `é€ä¿¡ä¸­ï¼š${d}/${total}`;
  blkBarInner.style.width = `${pct}%`;
}

// é€ä¿¡é–‹å§‹/çµ‚äº†ã®å…±é€šå‡¦ç†
async function startUploadGuard_(total){
  uploading = true;
  disableAll(true);
  showBlocker_(total, 0);
  enablePopGuard_();
  await requestWakeLock_();
}
async function endUploadGuard_(){
  uploading = false;
  hideBlocker_();
  disablePopGuard_();
  await releaseWakeLock_();
  disableAll(false);
}

const camBadge  = $('#camBadge');
const shotBadge = $('#shotBadge');

const camModal = $('#camModal');
const camVideo = $('#camVideo');
const camClose = $('#camClose');
const camShot  = $('#camShot');
let camStream = null;

// iOS(iPhone/iPad)ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚«ãƒ¡ãƒ©(input capture)ãŒæœ€ã‚‚é«˜ç”»è³ªãƒ»å®‰å®š
const IS_IOS =
  /iPad|iPhone|iPod/.test(navigator.userAgent) ||
  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPadOSå¯¾ç­–

/** ===== éµï¼šQRã®URLã«åŸ‹ã‚ã‚‹ â†’ ç«¯æœ«ä¿å­˜ â†’ URLã‹ã‚‰æ¶ˆã™ï¼ˆå…¥åŠ›ã‚¼ãƒ­ï¼‰ ===== */
const qs = new URLSearchParams(location.search);
let AUTH_KEY = (qs.get('k') || '').trim();
if (AUTH_KEY) {
  try { localStorage.setItem(KEY_STORAGE, AUTH_KEY); } catch(_) {}
  try { qs.delete('k'); history.replaceState(null,'', location.pathname + (qs.toString() ? '?' + qs.toString() : '')); } catch(_) {}
} else {
  try { AUTH_KEY = (localStorage.getItem(KEY_STORAGE) || '').trim(); } catch(_) {}
}

function requireKey(){
  if(!AUTH_KEY){
    precheck.className='msg msg-bad';
    precheck.textContent='âš  ã“ã®ç«¯æœ«ã¯æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é…å¸ƒã•ã‚ŒãŸQRã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚';
    disableAll(true);
    return false;
  }
  return true;
}
function disableAll(disabled){
  $('#pickBtn').disabled = disabled;
  $('#camBtn').disabled  = disabled;
  sendBtn.disabled       = disabled;
  $('#clearBtn').disabled= disabled;
}
function getSelectedDestIds(){
  return Array.from(destBox.querySelectorAll('input[type=checkbox]:checked')).map(x=>x.value);
}

/** ===== JSONPï¼ˆCORSå›é¿ï¼‰ ===== */
function jsonp(url, timeoutMs = 25000){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const sep = url.includes('?') ? '&' : '?';
    const s = document.createElement('script');

    const timeout = setTimeout(()=>{
      cleanup();
      reject(new Error('jsonp_timeout'));
    }, timeoutMs);

    window[cb] = (data)=>{ cleanup(); resolve(data); };

    function cleanup(){
      clearTimeout(timeout);
      try { delete window[cb]; } catch(_) { window[cb]=undefined; }
      if (s.parentNode) s.parentNode.removeChild(s);
    }

    s.src = url + sep + 'callback=' + encodeURIComponent(cb) + '&_=' + Date.now();
    s.onerror = ()=>{ cleanup(); reject(new Error('jsonp_error')); };
    document.head.appendChild(s);
  });
}

async function loadDestinations(){
  const js = await jsonp(API_ENDPOINT + '?action=listDest');
  if(!js.ok || !Array.isArray(js.dests)) throw new Error('listDest_failed');

  destBox.innerHTML='';
  for(const d of js.dests){
    const wrap = document.createElement('label');
    wrap.className='dest-item';
    wrap.innerHTML = `<input type="checkbox" value="${escapeHtml(d.id)}"><div class="dest-title">${escapeHtml(d.label)}</div>`;
    const cb = wrap.querySelector('input');
    cb.addEventListener('change', ()=> wrap.classList.toggle('active', cb.checked));
    destBox.appendChild(wrap);
  }
}

/** ===== UIæ“ä½œ ===== */
$('#pickBtn').onclick=()=>{
  if(!requireKey()) return;
  if(getSelectedDestIds().length===0){ msgBad('é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  pickInput.click();
};
$('#camBtn').onclick=()=>{
  if(!requireKey()) return;
  if(getSelectedDestIds().length===0){ msgBad('é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  openCameraOrFallback();
};
$('#clearBtn').onclick=()=>{ queue.length=0; render(); };

pickInput.addEventListener('change',e=>{ for(const f of e.target.files) queue.push(f); e.target.value=''; render(); });
cameraFile.addEventListener('change',e=>{
  for(const f of e.target.files) queue.push(f);
  e.target.value='';
  render();
});

/** ===== ã‚«ãƒ¡ãƒ© ===== */
async function openCameraOrFallback(){
  // iOSã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚«ãƒ¡ãƒ©ãŒä¸€ç•ªæ–‡å­—ãŒæ½°ã‚Œã«ãã„ï¼ˆé»’ã„æ¨™æº–UIï¼‰
  if (IS_IOS) {
    cameraFile.click();
    return;
  }

  // ãã‚Œä»¥å¤–ã¯è‡ªå‰ã‚«ãƒ¡ãƒ©ï¼ˆgetUserMediaï¼‰
  if (!navigator.mediaDevices?.getUserMedia) {
    cameraFile.click();
    return;
  }

  try {
    camStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'environment' },
        width:  { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    });

    camVideo.srcObject = camStream;
    if (camVideo.readyState < 2) {
      await new Promise(ok => camVideo.addEventListener('loadeddata', ok, { once: true }));
    }

    camModal.classList.add('show');
    document.body.style.overflow = 'hidden';
  } catch (_) {
    // æ¨©é™NGã‚„éå¯¾å¿œãªã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã¸
    cameraFile.click();
  }
}

function stopCamera(){
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
  camVideo.srcObject=null;
  camModal.classList.remove('show');
  document.body.style.overflow='';
}
camClose.onclick=()=>{ stopCamera(); render(); };
camShot.onclick=async ()=>{
  if(!camStream) return;
  const blob = await snapFromVideo();
  const d=new Date(), z=n=>String(n).padStart(2,'0');
  const name=`${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}.jpg`;
  queue.push(toFileLike(blob,name));
  render();
  updateBadges();
};
async function snapFromVideo(){
  // å¯èƒ½ãªã‚‰ã€Œå†™çœŸã€ã¨ã—ã¦å–å¾—ï¼ˆå‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ˆã‚Šæ–‡å­—ãŒæ½°ã‚Œã«ãã„ï¼‰
  try {
    const track = camStream?.getVideoTracks?.()[0];
    if (track && window.ImageCapture) {
      const cap = new ImageCapture(track);
      const blob = await cap.takePhoto();
      return blob; // å¤šãã¯ image/jpeg
    }
  } catch (_) {}

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’canvasåŒ–ï¼ˆè§£åƒåº¦ãƒ»å“è³ªã‚’ä¸Šã’ã‚‹ï¼‰
  const w = camVideo.videoWidth || 1920;
  const h = camVideo.videoHeight || 1080;
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  c.getContext('2d').drawImage(camVideo, 0, 0, w, h);

  return await blobFromCanvas(c, 'image/jpeg', 0.98); // 0.95 â†’ 0.98
}

async function blobFromCanvas(canvas,mime='image/jpeg',quality=0.95){
  if(canvas.toBlob){
    const b=await new Promise(res=>canvas.toBlob(res,mime,quality));
    if(b) return b;
  }
  return await (await fetch(canvas.toDataURL(mime,quality))).blob();
}
function toFileLike(blob,name){
  try{ return new File([blob], name, {type:blob.type||'image/jpeg'}); }
  catch(_){ Object.defineProperty(blob,'name',{value:name}); return blob; }
}

/** ===== é€ä¿¡ï¼ˆPOSTã¯no-corsã€çµæœã¯status(JSONP)ã§ç¢ºèªï¼‰ ===== */
$('#f').addEventListener('submit',(e)=>{
  e.preventDefault();
  if(!requireKey()) return;

  const destIds = getSelectedDestIds();
  if(destIds.length===0){ msgBad('é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  if(queue.length===0) return;

  (async ()=>{
    doneBox.style.display='none';

    const note = $('#note').value || '';
    const total = queue.length;

    await startUploadGuard_(total);

    for(let i=0;i<queue.length;i++){
      // æ—¢å­˜ã®è¡¨ç¤ºã‚‚æ®‹ã™ãªã‚‰ã“ã‚Œ
      progText.textContent = `é€ä¿¡ä¸­ï¼š${i+1}/${total}`;

      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å´ã®é€²æ—ã‚‚æ›´æ–°
      updateBlockerProgress_(total, i);

      const f = queue[i];

      const packed = await packToLimit(f, MAX_BYTES);
      const token = makeToken_();

      const payload = {
        key: AUTH_KEY,
        token,
        note,
        destIds,
        items: [{
          name: (f.name || 'upload.bin'),
          mime: packed.mime,
          base64: packed.base64
        }]
      };

      // no-cors POSTï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¤±æ•—æ™‚ã ã‘ãƒªãƒˆãƒ©ã‚¤ï¼‰
      await postNoCorsWithRetry_(payload, 2);

      // â˜…Driveå´ãŒ pending/status ã‚’æ›¸ãã¾ã§å°‘ã—å¾…ã¤ï¼ˆç¬é–“è² è·ãƒ»åæ˜ é…å»¶å¯¾ç­–ï¼‰
      await sleep_(600);

      // status ã‚’é•·ã‚ã«å¾…ã¤ï¼ˆ2åˆ†ï¼‰
      const st = await waitStatus_(token, 120000);

      if(!st.ok){
        await endUploadGuard_();
        const d = (st.detail ? ` / ${st.detail}` : '');
        msgBad(`é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${st.error || 'unknown'}${d}`);
        return;
      }
    }

    await endUploadGuard_();

    doneBox.style.display='block';
    queue.length=0;
    render();
  })().catch(async err=>{
    await endUploadGuard_(); // â˜…ã“ã‚Œå¿…é ˆ
    msgBad('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + (err?.message || String(err)));
    console.error(err);
  });
});

async function waitStatus_(token, timeoutMs = 120000){
  const start = Date.now();
  let backoff = 700;

  while(Date.now() - start < timeoutMs){
    try{
      const js = await jsonp(
        API_ENDPOINT + '?action=status&token=' + encodeURIComponent(token),
        25000
      );

      if(js && js.ok) return js;
      if(js && js.error) return js;     // ã‚µãƒ¼ãƒãŒã€Œç¢ºå®šã‚¨ãƒ©ãƒ¼ã€ã‚’è¿”ã—ãŸ
      // pending ã¯ç¶šè¡Œ
    }catch(err){
      // â˜…ã“ã“ãŒé‡è¦ï¼šJSONPå¤±æ•—ã¯â€œç¶šè¡Œâ€ã™ã‚‹ï¼ˆå›ç·šã®ç¬æ–­ã‚„æ··é›‘è€æ€§ï¼‰
    }

    await sleep_(backoff);
    backoff = Math.min(2000, Math.round(backoff * 1.15));
  }
  return { ok:false, error:'timeout' };
}
async function postNoCorsWithRetry_(payload, retries){
  const body = JSON.stringify(payload);

  for(let attempt = 0; attempt <= retries; attempt++){
    try{
      await fetchWithTimeout_(API_ENDPOINT, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type':'text/plain;charset=utf-8' },
        body
      }, 20000); // 1å›ã‚ãŸã‚Šã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆmsï¼‰

      // no-corsãªã®ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¸­èº«ã¯è¦‹ã‚Œãªã„ã€‚ã“ã“ã¾ã§æ¥ãŸã‚‰ã€Œé€šä¿¡ã¨ã—ã¦ã¯é€ã‚ŒãŸã€æ‰±ã„
      return;

    }catch(err){
      if(attempt >= retries) throw err;

      // ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆå°‘ã—ãšã¤å¾…ã¤ + ã°ã‚‰ã¤ãï¼‰
      const wait = 800 * (attempt + 1) + Math.floor(Math.random() * 500);
      await sleep_(wait);
    }
  }
}

// fetch ã‚’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§å®Ÿè¡Œï¼ˆAbortControllerãŒä½¿ãˆã‚‹ç’°å¢ƒã ã‘ abortï¼‰
async function fetchWithTimeout_(url, options, timeoutMs){
  if(typeof AbortController === 'undefined'){
    // å¤ã„ç’°å¢ƒå‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return await fetch(url, options);
  }

  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeoutMs);

  try{
    return await fetch(url, { ...options, signal: controller.signal });
  }finally{
    clearTimeout(id);
  }
}


function sleep_(ms){ return new Promise(r=>setTimeout(r,ms)); }
function makeToken_(){
  try{
    const a = new Uint32Array(4);
    crypto.getRandomValues(a);
    return Array.from(a).map(x=>x.toString(16)).join('') + '_' + Date.now();
  }catch(_){
    return Math.random().toString(36).slice(2) + '_' + Date.now();
  }
}

/** ===== è¡¨ç¤º ===== */
function render(){
  thumbs.innerHTML='';
  if(!requireKey()) return;

  if(queue.length>MAX_FILES){
    msgBad(`æœ€å¤§ ${MAX_FILES} æšã¾ã§ã§ã™ï¼ˆä»Š ${queue.length} æšï¼‰ã€‚æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
    sendBtn.disabled=true;
    return;
  }

  if(getSelectedDestIds().length===0){
    precheck.className='msg msg-info';
    precheck.textContent='é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
    sendBtn.disabled=true;
  }

  if(queue.length===0){
    precheck.className='msg msg-info';
    precheck.textContent='ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã‹ã€å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„ã€‚';
    sendBtn.disabled=true;
    return;
  }

  queue.forEach((f,i)=>{
    const card = document.createElement('div');
    card.className = 'thumb';

    const isImg = (f.type||'').startsWith('image/');

    if(isImg){
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      img.onload = ()=>URL.revokeObjectURL(img.src);
      card.appendChild(img);
    }else{
      const pdfStub = document.createElement('div');
      pdfStub.style.height='120px';
      pdfStub.style.display='flex';
      pdfStub.style.alignItems='center';
      pdfStub.style.justifyContent='center';
      pdfStub.style.background='#eef3ff';
      pdfStub.style.fontWeight='900';
      pdfStub.textContent='PDF';
      card.appendChild(pdfStub);

      // cardå…¨ä½“ã«ä»˜ã‘ãªã„
      pdfStub.style.cursor = 'pointer';
      pdfStub.title = 'ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã';
      pdfStub.onclick = (e)=>{
        e.stopPropagation();
        try{
          const url = URL.createObjectURL(f);
          window.open(url,'_blank','noopener');
          setTimeout(()=>URL.revokeObjectURL(url), 60000);
        }catch(_){}
      };

    }

    const meta = document.createElement('div');
    meta.className='meta';
    meta.innerHTML = `<div class="row"><strong>${escapeHtml(f.name||'file')}</strong></div>
                      <div class="row"><span>${(f.size/1024/1024).toFixed(1)}MB</span>
                      <button type="button" class="remove" data-i="${i}">å‰Šé™¤</button></div>`;
    card.appendChild(meta);
    thumbs.appendChild(card);
  });

  document.querySelectorAll('.remove').forEach(b=>{
    b.onpointerdown = (e)=>{ e.preventDefault(); e.stopPropagation(); };
    b.onclick = (e)=>{
      e.preventDefault();
      e.stopPropagation();
      queue.splice(Number(e.currentTarget.dataset.i),1);
      render();
    };
  });

  if(queue.some(f=>!ALLOW_MIME.includes((f.type||'').toLowerCase()))){
    msgBad('é€ä¿¡ã§ããªã„å½¢å¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆjpeg/png/pdfã®ã¿ï¼‰ã€‚');
    sendBtn.disabled=true; return;
  }

  const overs = queue.filter(f=>!(f.type||'').startsWith('image/') && f.size>MAX_BYTES);
  if(overs.length){
    msgBad('PDFãŒä¸Šé™ï¼ˆ20MBï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚åˆ†å‰²ã—ã¦é€ã£ã¦ãã ã•ã„ã€‚');
    sendBtn.disabled=true; return;
  }

  const sum=queue.reduce((s,f)=>s+f.size,0);
  precheck.className='msg msg-ok';
  precheck.innerHTML=`ğŸ‘ é€ä¿¡ã§ãã¾ã™ã€‚æšæ•°ï¼š<strong>${queue.length}</strong>ã€åˆè¨ˆï¼šç´„<strong>${(sum/1024/1024).toFixed(1)}MB</strong>`;
  sendBtn.disabled = (getSelectedDestIds().length===0);

  updateBadges();
}
function msgBad(t){
  precheck.className='msg msg-bad';
  precheck.textContent=t;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[c]));
}
function setBadge(el, n){
  if(!el) return;
  if(n > 0){
    el.style.display = 'inline-flex';
    el.textContent = String(n);
  }else{
    el.style.display = 'none';
    el.textContent = '';
  }
}
function updateBadges(){
  const photoCount = queue.filter(f => (f.type||'').startsWith('image/')).length;
  setBadge(camBadge, photoCount);
  setBadge(shotBadge, photoCount);
}

/** ===== ç”»åƒæœ€é©åŒ–ï¼ˆ20MBä»¥å†…ã«åã‚ã‚‹æœ€å°é™ï¼‰ ===== */
function readFileAsDataURL(file){ return new Promise((ok,ng)=>{ const r=new FileReader(); r.onload=()=>ok(r.result); r.onerror=ng; r.readAsDataURL(file); }); }
function loadImage(url){ return new Promise((ok,ng)=>{ const i=new Image(); i.onload=()=>ok(i); i.onerror=ng; i.src=url; }); }
async function hasAlphaChannel(img){
  const w=Math.min(img.width,512), h=Math.min(img.height,512);
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const d=ctx.getImageData(0,0,w,h).data;
  for(let i=3;i<d.length;i+=16){ if(d[i]<255) return true; }
  return false;
}
async function packToLimit(file,maxBytes){
  if(!((file.type||'').startsWith('image/'))){
    const dataUrl=await readFileAsDataURL(file);
    return { base64:dataUrl.split(',')[1], mime:(file.type||'application/octet-stream') };
  }

  const dataUrl=await readFileAsDataURL(file);
  let base64=dataUrl.split(',')[1];
  if(Math.ceil(base64.length*3/4)<=maxBytes) return { base64, mime:file.type||'image/jpeg' };

  const img=await loadImage(dataUrl);
  const isPng=/^image\/png$/i.test(file.type||'');
  const alpha=isPng ? await hasAlphaChannel(img) : false;

  if(!isPng || !alpha){
    for(const q of [0.92,0.86,0.80,0.74]){
      const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
      c.getContext('2d').drawImage(img,0,0);
      const out=c.toDataURL('image/jpeg',q);
      const b64=out.split(',')[1];
      if(Math.ceil(b64.length*3/4)<=maxBytes) return { base64:b64, mime:'image/jpeg' };
    }
    const ratio=Math.max(0.2, Math.sqrt(maxBytes/(Math.ceil(base64.length*3/4)))*0.92);
    const cw=Math.max(1,Math.round(img.width*ratio));
    const ch=Math.max(1,Math.round(img.height*ratio));
    const c2=document.createElement('canvas'); c2.width=cw; c2.height=ch;
    c2.getContext('2d').drawImage(img,0,0,cw,ch);
    const out2=c2.toDataURL('image/jpeg',0.86);
    return { base64:out2.split(',')[1], mime:'image/jpeg' };
  }

  let ratio=Math.max(0.2, Math.sqrt(maxBytes/(Math.ceil(base64.length*3/4)))*0.95);
  let cw=Math.max(1,Math.round(img.width*ratio));
  let ch=Math.max(1,Math.round(img.height*ratio));
  for(let t=0;t<3;t++){
    const c=document.createElement('canvas'); c.width=cw; c.height=ch;
    c.getContext('2d').drawImage(img,0,0,cw,ch);
    const out=c.toDataURL('image/png');
    const b64=out.split(',')[1];
    if(Math.ceil(b64.length*3/4)<=maxBytes) return { base64:b64, mime:'image/png' };
    cw=Math.max(1,Math.round(cw*0.85));
    ch=Math.max(1,Math.round(ch*0.85));
  }
  const c=document.createElement('canvas'); c.width=cw; c.height=ch;
  c.getContext('2d').drawImage(img,0,0,cw,ch);
  const out=c.toDataURL('image/jpeg',0.86);
  return { base64:out.split(',')[1], mime:'image/jpeg' };
}

// åˆæœŸåŒ–
(async ()=>{
  disableAll(false);
  if(!requireKey()) return;
  await loadDestinations();
  render();
})().catch(err=>{
  msgBad('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GitHubã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ServiceWorkerã¨ã€/exec URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  console.error(err);
});
</script>
</body>
</html>






