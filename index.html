<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</title>

  <!-- PWA / Theme -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#1556d1">

  <!-- Favicons -->
  <link rel="icon" href="./favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">

  <!-- iOS Home Screen -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="æ›¸é¡é€ä¿¡">

  <!-- (ä»»æ„) Windows -->
  <meta name="msapplication-TileColor" content="#1556d1">

<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{--primary:#1556d1;--danger:#ef5753;--ok:#137333;--fg:#111;--muted:#666;--bg:#f6f7fb;--card:#fff}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif;line-height:1.6;margin:0}
  .wrap{max-width:880px;margin:0 auto;padding:20px}
  .card{background:var(--card);border-radius:18px;box-shadow:0 2px 14px rgba(0,0,0,.06);padding:20px}
  h1{font-size:22px;margin:0 0 8px}
  label{display:block;font-weight:900;margin:14px 0 6px}
  input[type="text"]{width:100%;padding:14px 16px;border:1px solid #ddd;border-radius:14px;font-size:16px}

  .btn{appearance:none;border:0;border-radius:14px;padding:14px 16px;font-weight:900;font-size:16px;cursor:pointer;transition:transform .02s ease}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  .btn-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
  .btn-bar{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}

  .msg{padding:12px 14px;border-radius:12px;margin:10px 0;font-size:16px}
  .msg-ok{background:#e9f5ee;color:var(--ok);border:1px solid #bfe5cd}
  .msg-bad{background:#fdecec;color:#a12121;border:1px solid #f3c3c0}
  .msg-info{background:#eef3ff;color:#274291;border:1px solid #cfdcff}

  .mini{font-size:12px;color:var(--muted);margin-top:4px}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:10px}
  .thumb{background:#fafafa;border:1px solid #eee;border-radius:14px;overflow:hidden}
  .thumb img{width:100%;height:120px;object-fit:cover;display:block;background:#fff}
  .thumb .meta{padding:8px 10px;font-size:14px}
  .thumb .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .remove{background:#ffe7e7;color:#a12121;border:0;border-radius:10px;padding:6px 8px;font-weight:900;cursor:pointer}

  .progress{height:10px;background:#e8eefc;border-radius:999px;overflow:hidden;margin:10px 0 0}
  .bar{width:40%;height:100%;background:var(--primary);animation:indef 1.2s infinite}
  @keyframes indef{0%{transform:translateX(-60%)}100%{transform:translateX(160%)}}

  /* é€ä¿¡å…ˆ */
  /* ===== é€ä¿¡å…ˆï¼šã‚«ãƒ¼ãƒ‰å‹ãƒˆã‚°ãƒ«ï¼ˆè¦‹ãŸç›®å¼·åŒ–ï¼‰ ===== */
  .dest-box{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px;
    margin:10px 0 6px;
  }

  .dest-item{
    position:relative;
    display:flex;
    align-items:center;
    gap:12px;
    padding:14px 14px;
    border-radius:18px;
    cursor:pointer;
    user-select:none;

    background:linear-gradient(180deg,#ffffff 0%,#f7f9ff 100%);
    border:1px solid rgba(21,86,209,.18);
    box-shadow:0 1px 10px rgba(0,0,0,.05);

    transition:transform .08s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
  }

  .dest-item:hover{
    transform:translateY(-1px);
    box-shadow:0 10px 22px rgba(0,0,0,.08);
    border-color:rgba(21,86,209,.28);
  }

  .dest-item:active{
    transform:translateY(0px);
    box-shadow:0 6px 16px rgba(0,0,0,.08);
  }

  /* checkboxã¯â€œè¦‹ã›ãšã«æ®‹ã™â€ï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ç¶­æŒï¼‰ */
  .dest-item input{
    position:absolute;
    inset:0;
    opacity:0;
    width:100%;
    height:100%;
    margin:0;
    cursor:pointer;
  }

  /* å·¦ã®ãƒã‚§ãƒƒã‚¯ä¸¸ï¼ˆç–‘ä¼¼UIï¼‰ */
  .dest-item::before{
    content:"";
    width:22px;
    height:22px;
    border-radius:999px;
    border:2px solid rgba(21,86,209,.35);
    background:#fff;
    flex:0 0 22px;
    box-shadow:inset 0 0 0 3px rgba(255,255,255,1);
  }

  /* é¸æŠæ™‚ï¼šã‚«ãƒ¼ãƒ‰ã‚’å¼·èª¿ + ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ */
  .dest-item.active{
    border-color:rgba(21,86,209,.85);
    background:linear-gradient(180deg,#edf3ff 0%,#ffffff 100%);
    box-shadow:0 12px 26px rgba(21,86,209,.18);
  }

  .dest-item.active::before{
    border-color:rgba(21,86,209,1);
    background:radial-gradient(circle at 30% 30%, #ffffff 0%, #e6efff 40%, #d6e6ff 100%);
    box-shadow:inset 0 0 0 6px rgba(21,86,209,1);
  }

  /* å³ä¸Šã®â€œé¸æŠæ¸ˆã¿â€ãƒãƒƒã‚¸ */
  .dest-item.active::after{
    content:"é¸æŠä¸­";
    position:absolute;
    top:10px;
    right:10px;
    font-size:12px;
    font-weight:900;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(21,86,209,.10);
    color:rgba(21,86,209,1);
    border:1px solid rgba(21,86,209,.22);
  }

  /* ãƒ©ãƒ™ãƒ«æ–‡å­— */
  .dest-title{
    font-weight:900;
    font-size:17px;
    letter-spacing:.02em;
    line-height:1.2;
  }

  /* ã‚‚ã—éƒ¨ç½²åãŒé•·ã„å ´åˆã®å´©ã‚Œé˜²æ­¢ */
  .dest-title{
    word-break:break-word;
  }

  /* ã‚«ãƒ¡ãƒ© */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal.show{display:flex}
  .cam{background:#000;width:100%;max-width:1000px;color:#fff;display:flex;flex-direction:column;height:100svh}
  .cam video{flex:1 1 auto;width:100%;object-fit:cover}
  .cam .controls{display:flex;gap:10px;justify-content:space-between;padding:12px;background:rgba(0,0,0,.6)}
  .cam .btn{flex:1}

  /* æ’®å½±æšæ•°ãƒãƒƒã‚¸ã®è¦‹ãŸç›®ã‚’è¿½åŠ  */
  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:22px;
    height:22px;
    padding:0 7px;
    margin-left:8px;
    border-radius:999px;
    background:#fff;
    color:var(--primary);
    font-weight:900;
    font-size:13px;
    box-shadow:0 1px 4px rgba(0,0,0,.15);
  }

  /* ===== å…¨ç”»é¢ãƒ­ãƒƒã‚¯ ===== */
  .blocker{
    position:fixed; inset:0;
    background:rgba(0,0,0,.72);
    display:flex; align-items:center; justify-content:center;
    z-index:99999;
    padding:20px;
  }
  .blocker[hidden]{display:none}
  .blockerCard{
    width:min(560px, 100%);
    background:#fff;
    border-radius:18px;
    padding:18px;
    box-shadow:0 12px 40px rgba(0,0,0,.35);
  }
  /* ===== å…¨ç”»é¢ãƒ­ãƒƒã‚¯ï¼šä¸Šæ®µï¼ˆã‚¹ãƒ”ãƒŠãƒ¼ï¼‹ãƒ†ã‚­ã‚¹ãƒˆï¼‰å®Œå…¨ç‰ˆ ===== */
  .blkTop{
    display:flex;
    gap:14px;
    align-items:center;

    /* ç”»é¢ãŒç‹­ãã¦ã‚‚å´©ã‚Œã«ããã™ã‚‹ */
    flex-wrap:nowrap;
    min-width:0;          /* flexã®å­ãŒã¯ã¿å‡ºã™ã®ã‚’é˜²ãåœŸå° */
  }
  /* ãƒ†ã‚­ã‚¹ãƒˆå´ãŒæ¨ªã«è©°ã¾ã£ã¦ã‚‚ã€ŒæŠ˜ã‚Šè¿”ã—ã¦åã¾ã‚‹ã€ */
  .blkText{
    min-width:0;          /* â˜…ã“ã‚ŒãŒç„¡ã„ã¨çœç•¥/ã¯ã¿å‡ºã—äº‹æ•…ãŒèµ·ãã‚‹ */
    flex:1 1 auto;
  }

  /* ã‚¿ã‚¤ãƒˆãƒ«/ã‚µãƒ–ã®æŠ˜ã‚Šè¿”ã—ãƒ»è¦‹åˆ‡ã‚Œæœ€é©åŒ– */
  .blkTitle{
    font-weight:900;
    font-size:22px;
    line-height:1.2;
    word-break:break-word;
  }
  .blkSub{
    margin-top:2px;
    color:#444;
    font-weight:700;
    line-height:1.25;
    word-break:break-word;
  }
  /* ã‚¹ãƒ”ãƒŠãƒ¼ã¯ã€Œçµ¶å¯¾ã«æ½°ã‚Œãªã„ã€ */
  .spinner{
    width:44px;
    height:44px;
    min-width:44px;
    min-height:44px;
    flex:0 0 44px;
    aspect-ratio:1 / 1;

    border-radius:50%;
    border:5px solid rgba(21,86,209,.25);   /* è–„ã„ãƒªãƒ³ã‚° */
    border-top-color: rgba(21,86,209,1);     /* æ¿ƒã„â€œé‡â€ */

    animation: spin .9s linear infinite;
    -webkit-animation: spin .9s linear infinite; /* iOSä¿é™º */
    will-change: transform;
  }

  @keyframes spin{
    to{ transform: rotate(360deg); }
  }
  @-webkit-keyframes spin{
    to{
      -webkit-transform: rotate(360deg);
      transform: rotate(360deg);
    }
  }

  /* å°ã•ã„ç”»é¢ã§ã¯å°‘ã—è©°ã‚ã‚‹ï¼ˆä»»æ„ã ã‘ã©å®Ÿç”¨çš„ï¼‰ */
  @media (max-width: 380px){
    .blkTitle{ font-size:20px; }
    .spinner{
      width:40px; height:40px;
      min-width:40px; min-height:40px;
      flex:0 0 40px;
      border-width:5px;
    }
  }
  .blkProgress{margin-top:14px}
  .blkProgText{font-weight:900; margin-bottom:10px}
  .blkBar{height:14px; background:#e8eefc; border-radius:999px; overflow:hidden}
  .blkBarInner{height:100%; width:0% ; background:var(--primary); transition:width .25s ease}
  .blkMini{margin-top:8px; color:#666; font-size:13px}

  .blkFocus{
    position:absolute; left:-9999px; width:1px; height:1px; opacity:0;
  }

  /* ===== é€ä¿¡å…ˆï¼šèª­ã¿è¾¼ã¿ä¸­ãƒ­ãƒƒã‚¯ï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸èƒ½ï¼‰===== */
  #destBox{ position:relative; }
  
  /* loading ã‚¯ãƒ©ã‚¹ãŒä»˜ã„ã¦ã„ã‚‹é–“ã¯æ“ä½œä¸èƒ½ */
  #destBox.loading{
    pointer-events:none;   /* â˜…ã“ã‚Œã§ã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚¿ãƒƒãƒ—ä¸å¯ */
    opacity:.75;
  }
  
  /* ã†ã£ã™ã‚‰è¦†ã£ã¦ã€Œæ›´æ–°ä¸­ã€ã‚’æ˜ç¤ºï¼ˆå¥½ã¿ã§å‰Šé™¤OKï¼‰ */
  #destBox.loading::after{
    content:"é€ä¿¡å…ˆã‚’æ›´æ–°ä¸­â€¦";
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    color:var(--primary);
    background:rgba(255,255,255,.72);
    border-radius:18px;
    backdrop-filter: blur(2px);
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>

    <form id="f" autocomplete="off" novalidate>
      <label>é€ä¿¡å…ˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div id="destBox" class="dest-box"></div>
      <div class="mini">â€» é¸ã‚“ã éƒ¨ç½²ã™ã¹ã¦ã«åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>

      <label>åˆ©ç”¨è€…åãƒ»CMå ç­‰ï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="note" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒï¼CMåï¼äº‹æ¥­æ‰€å ãªã©" />

      <label>å†™çœŸãƒ»PDFï¼ˆæœ€å¤§ 5 æšï¼‰</label>
      <div class="btn-row">
        <button type="button" class="btn btn-primary" id="pickBtn">ğŸ“ ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸ã¶</button>
        <button type="button" class="btn btn-primary" id="camBtn">
          ğŸ“¸ å†™çœŸã‚’æ’®ã‚‹ <span id="camBadge" class="badge" style="display:none"></span>
        </button>
      </div>
      <div class="mini">â€» 1ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šé™ï¼š20MBï¼ˆjpeg / png / pdfï¼‰</div>

      <input id="pick" type="file" accept="image/jpeg,image/png,application/pdf" multiple style="display:none">
      <input id="cameraFile" type="file" accept="image/*" capture="environment" multiple
            style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0">

      <div class="btn-bar">
        <button type="button" class="btn btn-danger" id="clearBtn">âœ– ã™ã¹ã¦å‰Šé™¤</button>
      </div>

      <div id="installGuide" class="msg msg-info" style="display:none" role="status"></div>
      <div id="precheck" class="msg msg-info" role="status">æº–å‚™ä¸­â€¦</div>
      <div class="thumbs" id="thumbs"></div>

      <div class="btn-bar" style="margin-top:14px">
        <button class="btn btn-primary" id="sendBtn" type="submit" disabled>â¬† é€ä¿¡ã™ã‚‹</button>
      </div>

      <div id="sending" class="msg msg-info" style="display:none">
        â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚
        <div id="progText" class="mini" style="margin-top:6px"></div>
        <div class="progress"><div class="bar"></div></div>
      </div>

      <div id="done" class="msg msg-ok" style="display:none">
        <strong>âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ</strong>
      </div>
    </form>
  </div>
</div>

<!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="camModal" class="modal" aria-hidden="true">
  <div class="cam" role="dialog" aria-label="ã‚«ãƒ¡ãƒ©ã§æ’®å½±">
    <video id="camVideo" autoplay playsinline></video>
    <div class="controls">
      <button type="button" class="btn" id="camClose">é–‰ã˜ã‚‹</button>
      <button type="button" class="btn btn-primary" id="camShot">
        æ’®å½±ã—ã¦è¿½åŠ  <span id="shotBadge" class="badge" style="display:none"></span>
      </button>
    </div>
  </div>
</div>

<!-- é€ä¿¡ä¸­ãƒ­ãƒƒã‚¯ï¼ˆå…¨ç”»é¢ï¼‰ -->
<div id="blocker" class="blocker" hidden aria-hidden="true">
  <div class="blockerCard" role="alertdialog" aria-modal="true" aria-labelledby="blkTitle">
    <div class="blkTop">
      <div class="spinner" aria-hidden="true"></div>
      <div class="blkText">
        <div id="blkTitle" class="blkTitle">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™</div>
        <div class="blkSub">ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ï¼ˆé–‰ã˜ã‚‹ã¨å¤±æ•—ã—ã¾ã™ï¼‰</div>
      </div>
    </div>

    <div class="blkProgress">
      <div id="blkProgText" class="blkProgText">é€ä¿¡æº–å‚™ä¸­â€¦</div>
      <div class="blkBar"><div id="blkBarInner" class="blkBarInner"></div></div>
      <div class="blkMini">é›»æ³¢ãŒæ‚ªã„ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚</div>
    </div>

    <!-- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å›ºå®šç”¨ï¼ˆè¦–ç·š/æ“ä½œã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã«å¯„ã›ã‚‹ï¼‰ -->
    <button id="blkFocus" class="blkFocus" type="button">é€ä¿¡ä¸­</button>
  </div>
</div>

<script>
/* ====== ã‚ãªãŸã® /execï¼ˆåŸ‹ã‚è¾¼ã¿æ¸ˆã¿ï¼‰ ====== */
const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwtWxhYXS3Zr7sVRIwRDV7CGQg4mdcie2X3uC-WYJh0OBCBBEs60izW4CXk6eVkOYBpUQ/exec';
console.log('API_ENDPOINT=', API_ENDPOINT);

function renderDestinations_(dests){
  // â˜…å†æç”»å‰ã«ç¾åœ¨ã®é¸æŠã‚’é€€é¿
  try{
    selectedDestSet = new Set(getSelectedDestIds());
  }catch(_){
    selectedDestSet = new Set();
  }

  destBox.innerHTML='';

  for(const d of dests){
    const wrap = document.createElement('label');
    wrap.className='dest-item';
    wrap.innerHTML = `
      <input type="checkbox" value="${escapeHtml(d.id)}">
      <div class="dest-title">${escapeHtml(d.label)}</div>
    `;

    const cb = wrap.querySelector('input');

    // â˜…å¾©å…ƒ
    if(selectedDestSet.has(cb.value)){
      cb.checked = true;
      wrap.classList.add('active');
    }

    cb.addEventListener('change', ()=>{
      wrap.classList.toggle('active', cb.checked);
      if(cb.checked) selectedDestSet.add(cb.value);
      else selectedDestSet.delete(cb.value);
    });

    destBox.appendChild(wrap);
  }
}

function loadDestCache_(){
  try{
    const raw = localStorage.getItem(DEST_CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj?.ts || !Array.isArray(obj?.dests)) return null;
    if(Date.now() - obj.ts > DEST_CACHE_TTL_MS) return null;
    return obj.dests;
  }catch(_){
    return null;
  }
}

function saveDestCache_(dests){
  try{
    localStorage.setItem(DEST_CACHE_KEY, JSON.stringify({ ts: Date.now(), dests }));
  }catch(_){}
}

const MAX_FILES = 5;
const MAX_BYTES = 20*1024*1024;
const ALLOW_MIME = ['image/jpeg','image/png','image/heic','image/heif','application/pdf'];

const KEY_STORAGE = 'upload_key_v1';

// â˜…cookieãƒ–ãƒªãƒƒã‚¸
const KEY_COOKIE = 'upload_key_v1_cookie';

function setKeyCookie_(k){
  try{
    document.cookie =
      `${KEY_COOKIE}=${encodeURIComponent(k)}; Max-Age=31536000; Path=/; SameSite=Lax; Secure`;
  }catch(_){}
}

function getKeyCookie_(){
  try{
    const re = new RegExp('(?:^|; )' + KEY_COOKIE.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '=([^;]*)');
    const m = document.cookie.match(re);
    return m ? decodeURIComponent(m[1]) : '';
  }catch(_){
    return '';
  }
}

const queue = [];
let selectedDestSet = new Set();
const $ = s => document.querySelector(s);

const destBox = $('#destBox');
const pickInput = $('#pick');
const cameraFile = $('#cameraFile');
const thumbs = $('#thumbs');
const precheck = $('#precheck');
const sendBtn = $('#sendBtn');
const installGuide = $('#installGuide');
const sending = $('#sending');
const progText = $('#progText');
const doneBox = $('#done');

/* ====== ã“ã“ã‹ã‚‰è²¼ã‚Šä»˜ã‘ï¼ˆdestLoading + setDestLoadingUI_ï¼‰ ====== */
let destLoading = true;

function setDestLoadingUI_(on){
  destLoading = on;

  // â˜…é€ä¿¡å…ˆã‚¨ãƒªã‚¢ã‚’ãƒ­ãƒƒã‚¯
  destBox.classList.toggle('loading', on);
  destBox.setAttribute('aria-busy', on ? 'true' : 'false');

  // é€ä¿¡å…ˆã‚«ãƒ¼ãƒ‰é ˜åŸŸï¼šãƒ­ãƒ¼ãƒ‰ä¸­ã®è¦‹ãŸç›®ï¼ˆåˆå›ã ã‘ã‚¹ã‚±ãƒ«ãƒˆãƒ³ï¼‰
  if(on){
    const hasAny = !!destBox.querySelector('input[type=checkbox]');
    if(!hasAny){
      destBox.innerHTML = `
        ${[1,2,3,4].map(()=>`
          <div style="
            height:54px;border-radius:18px;
            border:1px solid rgba(0,0,0,.06);
            background:linear-gradient(90deg,#f2f4ff 0%,#ffffff 50%,#f2f4ff 100%);
            background-size:200% 100%;
            animation: sk 1.1s infinite;
          "></div>
        `).join('')}
      `;
    }
  }

  // ãƒ­ãƒ¼ãƒ‰å®Œäº†ã¾ã§ã¯æ“ä½œãƒœã‚¿ãƒ³ç„¡åŠ¹
  $('#pickBtn').disabled = on;
  $('#camBtn').disabled  = on;

  // é€ä¿¡ãƒœã‚¿ãƒ³ã‚‚ãƒ­ãƒ¼ãƒ‰ä¸­ã¯ç„¡åŠ¹
  if(on) sendBtn.disabled = true;

  // æ¡ˆå†…æ–‡
  if(on){
    precheck.className='msg msg-info';
    precheck.textContent='é€ä¿¡å…ˆã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦ï¼ˆé›»æ³¢ãŒæ‚ªã„ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰';
  }
}
  
// ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
const st = document.createElement('style');
st.textContent = `@keyframes sk{0%{background-position:0% 0}100%{background-position:200% 0}}`;
document.head.appendChild(st);

const blocker     = $('#blocker');
const blkProgText = $('#blkProgText');
const blkBarInner = $('#blkBarInner');
const blkFocus    = $('#blkFocus');

let uploading = false;
let wakeLock = null;
let popGuardOn = false;

// é€ä¿¡ä¸­ï¼šç”»é¢ã‚¹ãƒªãƒ¼ãƒ—æŠ‘æ­¢ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
async function requestWakeLock_(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', ()=>{ wakeLock=null; });
    }
  }catch(_){}
}
async function releaseWakeLock_(){
  try{ if(wakeLock) await wakeLock.release(); }catch(_){}
  wakeLock=null;
}

// æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå±¥æ­´æˆ»ã‚Šï¼‰æŠ‘æ­¢
function enablePopGuard_(){
  if(popGuardOn) return;
  popGuardOn = true;
  try{ history.pushState({uploading:1}, '', location.href); }catch(_){}
  window.addEventListener('popstate', onPopState_);
}
function disablePopGuard_(){
  if(!popGuardOn) return;
  popGuardOn = false;
  window.removeEventListener('popstate', onPopState_);
}
function onPopState_(){
  if(!uploading) return;
  try{ history.pushState({uploading:1}, '', location.href); }catch(_){}
  alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã¯æˆ»ã‚Œã¾ã›ã‚“ã€‚å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚');
}

// ã‚¿ãƒ–/æ›´æ–°/é–‰ã˜ã‚‹è­¦å‘Šï¼ˆiPhoneã¯åŠ¹ãã«ãã„ãŒã€PCã¯åŠ¹ãï¼‰
window.addEventListener('beforeunload', (e)=>{
  if(!uploading) return;
  e.preventDefault();
  e.returnValue = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚é–‰ã˜ã‚‹ã¨é€ä¿¡ãŒå¤±æ•—ã—ã¾ã™ã€‚';
  return e.returnValue;
});

function showBlocker_(total, index){
  blocker.hidden = false;
  blocker.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¼·åˆ¶ï¼ˆè¦–ç·šèª˜å° + å¤‰ãªæ“ä½œã‚’æ¸›ã‚‰ã™ï¼‰
  try{ blkFocus.focus({preventScroll:true}); }catch(_){}
  updateBlockerProgress_(total, index);
}
function hideBlocker_(){
  blocker.hidden = true;
  blocker.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
}
function updateBlockerProgress_(total, done){
  const d = Math.max(0, Math.min(done, total));
  const pct = total ? Math.round((d/total)*100) : 0;
  blkProgText.textContent = `é€ä¿¡ä¸­ï¼š${d}/${total}`;
  blkBarInner.style.width = `${pct}%`;
}

// é€ä¿¡é–‹å§‹/çµ‚äº†ã®å…±é€šå‡¦ç†
async function startUploadGuard_(total){
  uploading = true;
  disableAll(true);
  showBlocker_(total, 0);
  enablePopGuard_();
  await requestWakeLock_();
}
async function endUploadGuard_(){
  uploading = false;
  hideBlocker_();
  disablePopGuard_();
  await releaseWakeLock_();
  disableAll(false);
}

const camBadge  = $('#camBadge');
const shotBadge = $('#shotBadge');

const camModal = $('#camModal');
const camVideo = $('#camVideo');
const camClose = $('#camClose');
const camShot  = $('#camShot');
let camStream = null;

// iOS(iPhone/iPad)ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚«ãƒ¡ãƒ©(input capture)ãŒæœ€ã‚‚é«˜ç”»è³ªãƒ»å®‰å®š
const IS_IOS =
  /iPad|iPhone|iPod/.test(navigator.userAgent) ||
  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPadOSå¯¾ç­–

/** ===== éµï¼šQRã®URLã«åŸ‹ã‚ã‚‹ â†’ ç«¯æœ«ä¿å­˜ï¼ˆsearch/hash + cookieï¼‰ ===== */
const qs = new URLSearchParams(location.search);
const hs = new URLSearchParams((location.hash || '').replace(/^#/, ''));

// install=1 ã¯ search/hashã©ã¡ã‚‰ã§ã‚‚OK
const installMode = (qs.get('install') === '1') || (hs.get('install') === '1');

// iOSãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆstandaloneï¼‰åˆ¤å®š
const IS_STANDALONE =
  window.matchMedia('(display-mode: standalone)').matches ||
  (typeof navigator.standalone !== 'undefined' && navigator.standalone);

// k ã¯ search/hash ã‹ã‚‰å„ªå…ˆå–å¾—
let AUTH_KEY = (qs.get('k') || hs.get('k') || '').trim();

if (AUTH_KEY) {
  // localStorage ã¨ cookie ã®ä¸¡æ–¹ã¸ä¿å­˜ï¼ˆï¼Safariâ†’ãƒ›ãƒ¼ãƒ ç”»é¢ã®æ©‹æ¸¡ã—ï¼‰
  try { localStorage.setItem(KEY_STORAGE, AUTH_KEY); } catch(_) {}
  setKeyCookie_(AUTH_KEY);

  // â˜…æ¶ˆã™ã‚¿ã‚¤ãƒŸãƒ³ã‚°
  // - install=1 ã®Safariã§ã¯æ¶ˆã•ãªã„ï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ æ™‚ã«URLã‚’ä¿ã¤ãŸã‚ï¼‰
  // - standaloneã§ã¯æ¶ˆã™ï¼ˆä»¥å¾ŒURLã«æ®‹ã•ãªã„ï¼‰
  // - installã§ãªã„é€šå¸¸é‹ç”¨ã¯æ¶ˆã—ã¦OK
  const shouldStrip = IS_STANDALONE || !installMode;

  if (shouldStrip) {
    try {
      qs.delete('k'); qs.delete('install');
      hs.delete('k'); hs.delete('install');

      const q = qs.toString();
      const h = hs.toString();

      history.replaceState(null, '', location.pathname + (q ? '?' + q : '') + (h ? '#' + h : ''));
    } catch(_) {}
  }
} else {
  // URLã«ç„¡ã‘ã‚Œã° storageâ†’cookie ã®é †ã§å¾©å…ƒ
  try { AUTH_KEY = (localStorage.getItem(KEY_STORAGE) || '').trim(); } catch(_) {}
  if (!AUTH_KEY) AUTH_KEY = (getKeyCookie_() || '').trim();

  // cookieã‹ã‚‰å¾©å…ƒã§ããŸã‚‰ã€ä»Šã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®localStorageã«ã‚‚æˆ»ã™
  if (AUTH_KEY) {
    try { localStorage.setItem(KEY_STORAGE, AUTH_KEY); } catch(_) {}
  }
}

function updateInstallGuide_(){
  // install=1 ã‹ã¤ Safariï¼ˆ= standalone ã§ã¯ãªã„ï¼‰ã ã‘æ¡ˆå†…è¡¨ç¤º
  if(installMode && !IS_STANDALONE){
    const shareHint = IS_IOS ? 'ç”»é¢ä¸‹ã®å…±æœ‰ï¼ˆâ–¡â†‘ï¼‰' : 'ãƒ–ãƒ©ã‚¦ã‚¶å³ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆï¸™ï¼‰';
    installGuide.style.display = 'block';
    installGuide.className = 'msg msg-info';
    installGuide.innerHTML = `
      <strong>ğŸ“Œ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ãã ã•ã„</strong><br>
      æ¬¡å›ã‹ã‚‰è¿·ã‚ãªã„ãŸã‚ã«ã€<b>ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰é–‹ãé‹ç”¨</b>ã«ã—ã¾ã™ã€‚<br>
      <ol style="margin:8px 0 0 18px;padding:0">
        <li>${shareHint} ã‚’ã‚¿ãƒƒãƒ—</li>
        <li>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</li>
        <li>è¿½åŠ ã—ãŸ <b>æ›¸é¡é€ä¿¡</b> ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰é–‹ã</li>
      </ol>
      <div class="mini">â€» è¿½åŠ å¾Œã¯ã€ã“ã®QRã‚’ä½¿ã‚ãšã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã§OKã§ã™ã€‚</div>
      <div class="mini">â€» LINEç­‰ã®å†…è”µãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰ã€ŒSafariã§é–‹ãã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div>
    `;
  }else{
    installGuide.style.display = 'none';
    installGuide.innerHTML = '';
  }
}

function requireKey(){
  // â˜…æœ€å¾Œã®ä¿é™ºï¼šã“ã“ã§ã‚‚cookieã‹ã‚‰å¾©å…ƒã‚’è©¦ã™
  if(!AUTH_KEY){
    const ck = (getKeyCookie_() || '').trim();
    if(ck){
      AUTH_KEY = ck;
      try { localStorage.setItem(KEY_STORAGE, AUTH_KEY); } catch(_) {}
    }
  }

  if(!AUTH_KEY){
    precheck.className='msg msg-bad';
    precheck.textContent='âš  ã“ã®ç«¯æœ«ã¯æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é…å¸ƒã•ã‚ŒãŸQRã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚';
    disableAll(true);
    return false;
  }
  return true;
}

function disableAll(disabled){
  $('#pickBtn').disabled = disabled;
  $('#camBtn').disabled  = disabled;
  sendBtn.disabled       = disabled;
  $('#clearBtn').disabled= disabled;
}
function getSelectedDestIds(){
  return Array.from(destBox.querySelectorAll('input[type=checkbox]:checked')).map(x=>x.value);
}

/** ===== JSONPï¼ˆCORSå›é¿ï¼‰ ===== */
function jsonp(url, timeoutMs = 25000){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const sep = url.includes('?') ? '&' : '?';
    const s = document.createElement('script');

    const timeout = setTimeout(()=>{
      cleanup();
      reject(new Error('jsonp_timeout'));
    }, timeoutMs);

    window[cb] = (data)=>{ cleanup(); resolve(data); };

    function cleanup(){
      clearTimeout(timeout);
      try { delete window[cb]; } catch(_) { window[cb]=undefined; }
      if (s.parentNode) s.parentNode.removeChild(s);
    }

    s.src = url + sep + 'callback=' + encodeURIComponent(cb) + '&_=' + Date.now();
    s.onerror = ()=>{ cleanup(); reject(new Error('jsonp_error')); };
    document.head.appendChild(s);
  });
}

const DEST_CACHE_KEY = 'dest_cache_v1:' + API_ENDPOINT;
const DEST_CACHE_TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7æ—¥

async function loadDestinations(){
  // 1) ã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥è¡¨ç¤ºï¼ˆå³ï¼‰
  const cached = loadDestCache_();
  if(cached && cached.length){
    renderDestinations_(cached);
  }

  // 2) è£ã§æœ€æ–°å–å¾—ï¼ˆé…ãã¦ã‚‚UIã¯å…ˆã«å‡ºã‚‹ï¼‰
  const js = await jsonp(API_ENDPOINT + '?action=listDest');
  if(!js.ok || !Array.isArray(js.dests)) throw new Error('listDest_failed');

  renderDestinations_(js.dests);
  saveDestCache_(js.dests);
}

/** ===== UIæ“ä½œ ===== */
$('#pickBtn').onclick=()=>{
  if(destLoading){ msgBad('é€ä¿¡å…ˆã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ãã ã•ã„ã€‚'); return; } // â˜…è¿½åŠ 
  if(!requireKey()) return;
  if(getSelectedDestIds().length===0){ msgBad('é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  pickInput.click();
};

$('#camBtn').onclick=()=>{
  if(destLoading){ msgBad('é€ä¿¡å…ˆã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ãã ã•ã„ã€‚'); return; } // â˜…è¿½åŠ 
  if(!requireKey()) return;
  if(getSelectedDestIds().length===0){ msgBad('é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  openCameraOrFallback();
};
$('#clearBtn').onclick=()=>{ queue.length=0; render(); };

pickInput.addEventListener('change',e=>{ for(const f of e.target.files) queue.push(f); e.target.value=''; render(); });
cameraFile.addEventListener('change',e=>{
  for(const f of e.target.files) queue.push(f);
  e.target.value='';
  render();
});

/** ===== ã‚«ãƒ¡ãƒ© ===== */
async function openCameraOrFallback(){
  // iOSã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚«ãƒ¡ãƒ©ãŒä¸€ç•ªæ–‡å­—ãŒæ½°ã‚Œã«ãã„ï¼ˆé»’ã„æ¨™æº–UIï¼‰
  if (IS_IOS) {
    cameraFile.click();
    return;
  }

  // ãã‚Œä»¥å¤–ã¯è‡ªå‰ã‚«ãƒ¡ãƒ©ï¼ˆgetUserMediaï¼‰
  if (!navigator.mediaDevices?.getUserMedia) {
    cameraFile.click();
    return;
  }

  try {
    camStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'environment' },
        width:  { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    });

    camVideo.srcObject = camStream;
    if (camVideo.readyState < 2) {
      await new Promise(ok => camVideo.addEventListener('loadeddata', ok, { once: true }));
    }

    camModal.classList.add('show');
    document.body.style.overflow = 'hidden';
  } catch (_) {
    // æ¨©é™NGã‚„éå¯¾å¿œãªã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã¸
    cameraFile.click();
  }
}

function stopCamera(){
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
  camVideo.srcObject=null;
  camModal.classList.remove('show');
  document.body.style.overflow='';
}
camClose.onclick=()=>{ stopCamera(); render(); };
camShot.onclick=async ()=>{
  if(!camStream) return;
  const blob = await snapFromVideo();
  const d=new Date(), z=n=>String(n).padStart(2,'0');
  const name=`${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}.jpg`;
  queue.push(toFileLike(blob,name));
  render();
  updateBadges();
};
async function snapFromVideo(){
  // å¯èƒ½ãªã‚‰ã€Œå†™çœŸã€ã¨ã—ã¦å–å¾—ï¼ˆå‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ˆã‚Šæ–‡å­—ãŒæ½°ã‚Œã«ãã„ï¼‰
  try {
    const track = camStream?.getVideoTracks?.()[0];
    if (track && window.ImageCapture) {
      const cap = new ImageCapture(track);
      const blob = await cap.takePhoto();
      return blob; // å¤šãã¯ image/jpeg
    }
  } catch (_) {}

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’canvasåŒ–ï¼ˆè§£åƒåº¦ãƒ»å“è³ªã‚’ä¸Šã’ã‚‹ï¼‰
  const w = camVideo.videoWidth || 1920;
  const h = camVideo.videoHeight || 1080;
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  c.getContext('2d').drawImage(camVideo, 0, 0, w, h);

  return await blobFromCanvas(c, 'image/jpeg', 0.98); // 0.95 â†’ 0.98
}

async function blobFromCanvas(canvas,mime='image/jpeg',quality=0.95){
  if(canvas.toBlob){
    const b=await new Promise(res=>canvas.toBlob(res,mime,quality));
    if(b) return b;
  }
  return await (await fetch(canvas.toDataURL(mime,quality))).blob();
}
function toFileLike(blob,name){
  try{ return new File([blob], name, {type:blob.type||'image/jpeg'}); }
  catch(_){ Object.defineProperty(blob,'name',{value:name}); return blob; }
}

/** ===== é€ä¿¡ï¼ˆPOSTã¯no-corsã€çµæœã¯status(JSONP)ã§ç¢ºèªï¼‰ ===== */
$('#f').addEventListener('submit',(e)=>{
  e.preventDefault();
  if(!requireKey()) return;

  const destIds = getSelectedDestIds();
  if(destIds.length===0){ msgBad('é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  if(queue.length===0) return;

  (async ()=>{
    doneBox.style.display='none';

    const note = $('#note').value || '';
    const total = queue.length;

    await startUploadGuard_(total);

    for(let i=0;i<queue.length;i++){
      // æ—¢å­˜ã®è¡¨ç¤ºã‚‚æ®‹ã™ãªã‚‰ã“ã‚Œ
      progText.textContent = `é€ä¿¡ä¸­ï¼š${i+1}/${total}`;

      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å´ã®é€²æ—ã‚‚æ›´æ–°
      updateBlockerProgress_(total, i);

      const f = queue[i];

      const packed = await packToLimit(f, MAX_BYTES);
      const token = makeToken_();

      const payload = {
        key: AUTH_KEY,
        token,
        note,
        destIds,
        items: [{
          name: (f.name || 'upload.bin'),
          mime: packed.mime,
          base64: packed.base64
        }]
      };

      // no-cors POSTï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¤±æ•—æ™‚ã ã‘ãƒªãƒˆãƒ©ã‚¤ï¼‰
      await postNoCorsWithRetry_(payload, 2);

      // â˜…Driveå´ãŒ pending/status ã‚’æ›¸ãã¾ã§å°‘ã—å¾…ã¤ï¼ˆç¬é–“è² è·ãƒ»åæ˜ é…å»¶å¯¾ç­–ï¼‰
      await sleep_(600);

      // status ã‚’é•·ã‚ã«å¾…ã¤ï¼ˆ2åˆ†ï¼‰
      const st = await waitStatus_(token, 120000);

      if(!st.ok){
        await endUploadGuard_();
        const d = (st.detail ? ` / ${st.detail}` : '');
        msgBad(`é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${st.error || 'unknown'}${d}`);
        return;
      }
    }

    await endUploadGuard_();

    doneBox.style.display='block';

    // â˜…è¿½åŠ ï¼šè¦‹ãŸç›®ã‚’å®Œå…¨ã«åˆæœŸåŒ–ï¼ˆä¸å®‰ã‚’æ¶ˆã™ï¼‰
    resetUiAfterSuccess_();
    
    queue.length=0;
    render();
  })().catch(async err=>{
    await endUploadGuard_(); // â˜…ã“ã‚Œå¿…é ˆ
    msgBad('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + (err?.message || String(err)));
    console.error(err);
  });
});

async function waitStatus_(token, timeoutMs = 120000){
  const start = Date.now();
  let backoff = 700;

  while(Date.now() - start < timeoutMs){
    try{
      const js = await jsonp(
        API_ENDPOINT + '?action=status&token=' + encodeURIComponent(token),
        25000
      );

      if(js && js.ok) return js;
      if(js && js.error) return js;     // ã‚µãƒ¼ãƒãŒã€Œç¢ºå®šã‚¨ãƒ©ãƒ¼ã€ã‚’è¿”ã—ãŸ
      // pending ã¯ç¶šè¡Œ
    }catch(err){
      // â˜…ã“ã“ãŒé‡è¦ï¼šJSONPå¤±æ•—ã¯â€œç¶šè¡Œâ€ã™ã‚‹ï¼ˆå›ç·šã®ç¬æ–­ã‚„æ··é›‘è€æ€§ï¼‰
    }

    await sleep_(backoff);
    backoff = Math.min(2000, Math.round(backoff * 1.15));
  }
  return { ok:false, error:'timeout' };
}
async function postNoCorsWithRetry_(payload, retries){
  const body  = JSON.stringify(payload);
  const token = payload.token;

  for(let attempt = 0; attempt <= retries; attempt++){
    try{
      await fetchWithTimeout_(API_ENDPOINT, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type':'text/plain;charset=utf-8' },
        body
      }, 60000); // â˜…20sâ†’60sæ¨å¥¨ï¼ˆAbortèµ·å› ã®é‡è¤‡ã‚’æ¸›ã‚‰ã™ï¼‰

      return; // é€šä¿¡ã¨ã—ã¦é€ã‚ŒãŸæ‰±ã„

    }catch(err){
      // â˜…é‡è¦ï¼šPOSTãŒå¤±æ•—ã—ãŸâ€œã‚ˆã†ã«è¦‹ãˆã¦ã‚‚â€ã‚µãƒ¼ãƒã«å±Šã„ã¦ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
      // å…ˆã« status ã‚’æ•°å›ç¢ºèªã—ã¦ã€pending/ok ãªã‚‰å†é€ã—ãªã„
      const delivered = await probeDeliveredByStatus_(token);
      if(delivered) return;

      if(attempt >= retries) throw err;

      const wait = 800 * (attempt + 1) + Math.floor(Math.random() * 500);
      await sleep_(wait);
    }
  }
}

async function probeDeliveredByStatus_(token){
  // 10ç§’ãã‚‰ã„æ§˜å­ã‚’è¦‹ã‚‹ï¼ˆã‚µãƒ¼ãƒãŒstatusæ›¸ãã¾ã§ãƒ©ã‚°ã‚‹ã“ã¨ãŒã‚ã‚‹ï¼‰
  const limitMs = 10000;
  const start = Date.now();

  while(Date.now() - start < limitMs){
    try{
      const st = await jsonp(
        API_ENDPOINT + '?action=status&token=' + encodeURIComponent(token),
        15000
      );

      // ok ãªã‚‰å½“ç„¶å±Šã„ã¦ã‚‹
      if(st && st.ok) return true;

      // errorã§ã‚‚ã€Œnot_foundç³»ã€ä»¥å¤–ãªã‚‰ã€ã‚µãƒ¼ãƒå´ã§ä½•ã‹èµ·ãã¦ã„ã¦å±Šã„ã¦ã‚‹å¯èƒ½æ€§ãŒé«˜ã„
      if(st && st.error && !/not_?found|no_?token|missing/i.test(String(st.error))){
        return true;
      }

      // pendingï¼ˆã‚ãªãŸã®å®Ÿè£…ã§ã¯ okã‚‚errorã‚‚ç„¡ã„çŠ¶æ…‹ï¼‰ãªã‚‰å±Šã„ã¦ã‚‹é€”ä¸­ã¨åˆ¤æ–­
      if(st && !st.ok && !st.error){
        return true;
      }
    }catch(_){
      // JSONPå¤±æ•—ã¯ç„¡è¦–ï¼ˆå›ç·šæ‚ªåŒ–æ™‚ï¼‰
    }
    await sleep_(800);
  }
  return false;
}

// fetch ã‚’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§å®Ÿè¡Œï¼ˆAbortControllerãŒä½¿ãˆã‚‹ç’°å¢ƒã ã‘ abortï¼‰
async function fetchWithTimeout_(url, options, timeoutMs){
  if(typeof AbortController === 'undefined'){
    // å¤ã„ç’°å¢ƒå‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return await fetch(url, options);
  }

  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeoutMs);

  try{
    return await fetch(url, { ...options, signal: controller.signal });
  }finally{
    clearTimeout(id);
  }
}


function sleep_(ms){ return new Promise(r=>setTimeout(r,ms)); }
function makeToken_(){
  try{
    const a = new Uint32Array(4);
    crypto.getRandomValues(a);
    return Array.from(a).map(x=>x.toString(16)).join('') + '_' + Date.now();
  }catch(_){
    return Math.random().toString(36).slice(2) + '_' + Date.now();
  }
}

/** ===== è¡¨ç¤º ===== */
function render(){
  thumbs.innerHTML='';
  if(!requireKey()) return;

  // â˜…è¿½åŠ ï¼šqueueãŒç©ºã§ã‚‚å¿…ãšãƒãƒƒã‚¸ã‚’åŒæœŸï¼ˆé€ä¿¡å¾Œã«æ®‹ã‚‹å•é¡Œã‚’æ½°ã™ï¼‰
  updateBadges();
  
  if(queue.length>MAX_FILES){
    msgBad(`æœ€å¤§ ${MAX_FILES} æšã¾ã§ã§ã™ï¼ˆä»Š ${queue.length} æšï¼‰ã€‚æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
    sendBtn.disabled=true;
    return;
  }

  if(getSelectedDestIds().length===0){
    precheck.className='msg msg-info';
    precheck.textContent='é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
    sendBtn.disabled=true;
  }

  if(queue.length===0){
    precheck.className='msg msg-info';
    precheck.textContent='ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã‹ã€å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„ã€‚';
    sendBtn.disabled=true;
    return;
  }

  queue.forEach((f,i)=>{
    const card = document.createElement('div');
    card.className = 'thumb';

    const isImg = (f.type||'').startsWith('image/');

    if(isImg){
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      img.onload = ()=>URL.revokeObjectURL(img.src);
      card.appendChild(img);
    }else{
      const pdfStub = document.createElement('div');
      pdfStub.style.height='120px';
      pdfStub.style.display='flex';
      pdfStub.style.alignItems='center';
      pdfStub.style.justifyContent='center';
      pdfStub.style.background='#eef3ff';
      pdfStub.style.fontWeight='900';
      pdfStub.textContent='PDF';
      card.appendChild(pdfStub);

      // cardå…¨ä½“ã«ä»˜ã‘ãªã„
      pdfStub.style.cursor = 'pointer';
      pdfStub.title = 'ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã';
      pdfStub.onclick = (e)=>{
        e.stopPropagation();
        try{
          const url = URL.createObjectURL(f);
          window.open(url,'_blank','noopener');
          setTimeout(()=>URL.revokeObjectURL(url), 60000);
        }catch(_){}
      };

    }

    const meta = document.createElement('div');
    meta.className='meta';
    meta.innerHTML = `<div class="row"><strong>${escapeHtml(f.name||'file')}</strong></div>
                      <div class="row"><span>${(f.size/1024/1024).toFixed(1)}MB</span>
                      <button type="button" class="remove" data-i="${i}">å‰Šé™¤</button></div>`;
    card.appendChild(meta);
    thumbs.appendChild(card);
  });

  document.querySelectorAll('.remove').forEach(b=>{
    b.onpointerdown = (e)=>{ e.preventDefault(); e.stopPropagation(); };
    b.onclick = (e)=>{
      e.preventDefault();
      e.stopPropagation();
      queue.splice(Number(e.currentTarget.dataset.i),1);
      render();
    };
  });

  if(queue.some(f=>!ALLOW_MIME.includes((f.type||'').toLowerCase()))){
    msgBad('é€ä¿¡ã§ããªã„å½¢å¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆjpeg/png/pdfã®ã¿ï¼‰ã€‚');
    sendBtn.disabled=true; return;
  }

  const overs = queue.filter(f=>!(f.type||'').startsWith('image/') && f.size>MAX_BYTES);
  if(overs.length){
    msgBad('PDFãŒä¸Šé™ï¼ˆ20MBï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚åˆ†å‰²ã—ã¦é€ã£ã¦ãã ã•ã„ã€‚');
    sendBtn.disabled=true; return;
  }

  const sum=queue.reduce((s,f)=>s+f.size,0);
  precheck.className='msg msg-ok';
  precheck.innerHTML=`ğŸ‘ é€ä¿¡ã§ãã¾ã™ã€‚æšæ•°ï¼š<strong>${queue.length}</strong>ã€åˆè¨ˆï¼šç´„<strong>${(sum/1024/1024).toFixed(1)}MB</strong>`;
  sendBtn.disabled = (getSelectedDestIds().length===0);

  updateBadges();
}
function msgBad(t){
  precheck.className='msg msg-bad';
  precheck.textContent=t;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[c]));
}
function setBadge(el, n){
  if(!el) return;
  if(n > 0){
    el.style.display = 'inline-flex';
    el.textContent = String(n);
  }else{
    el.style.display = 'none';
    el.textContent = '';
  }
}
function updateBadges(){
  const photoCount = queue.filter(f => (f.type||'').startsWith('image/')).length;
  setBadge(camBadge, photoCount);
  setBadge(shotBadge, photoCount);
}

// â˜…ã“ã“ã«è¿½åŠ ï¼ˆrender() ã®å‰ã§ã‚‚å¾Œã§ã‚‚OKã ãŒã€ã“ã®è¾ºãŒå®‰å…¨ï¼‰
function resetUiAfterSuccess_(){
  queue.length = 0;
  thumbs.innerHTML = '';

  try { $('#note').value = ''; } catch(_){}

  try{
    destBox.querySelectorAll('input[type=checkbox]').forEach(cb=>{
      cb.checked = false;
      const item = cb.closest('.dest-item');
      if(item) item.classList.remove('active');
    });
  }catch(_){}

  updateBadges();
  sendBtn.disabled = true;

  precheck.className='msg msg-info';
  precheck.textContent='é€ä¿¡å…ˆã‚’é¸ã‚“ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã‹å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„ã€‚';
}
  
/** ===== ç”»åƒæœ€é©åŒ–ï¼ˆ20MBä»¥å†…ã«åã‚ã‚‹æœ€å°é™ï¼‰ ===== */
function readFileAsDataURL(file){ return new Promise((ok,ng)=>{ const r=new FileReader(); r.onload=()=>ok(r.result); r.onerror=ng; r.readAsDataURL(file); }); }
function loadImage(url){ return new Promise((ok,ng)=>{ const i=new Image(); i.onload=()=>ok(i); i.onerror=ng; i.src=url; }); }
async function hasAlphaChannel(img){
  const w=Math.min(img.width,512), h=Math.min(img.height,512);
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const d=ctx.getImageData(0,0,w,h).data;
  for(let i=3;i<d.length;i+=16){ if(d[i]<255) return true; }
  return false;
}
async function packToLimit(file,maxBytes){
  if(!((file.type||'').startsWith('image/'))){
    const dataUrl=await readFileAsDataURL(file);
    return { base64:dataUrl.split(',')[1], mime:(file.type||'application/octet-stream') };
  }

  const dataUrl=await readFileAsDataURL(file);
  let base64=dataUrl.split(',')[1];
  if(Math.ceil(base64.length*3/4)<=maxBytes) return { base64, mime:file.type||'image/jpeg' };

  const img=await loadImage(dataUrl);
  const isPng=/^image\/png$/i.test(file.type||'');
  const alpha=isPng ? await hasAlphaChannel(img) : false;

  if(!isPng || !alpha){
    for(const q of [0.92,0.86,0.80,0.74]){
      const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
      c.getContext('2d').drawImage(img,0,0);
      const out=c.toDataURL('image/jpeg',q);
      const b64=out.split(',')[1];
      if(Math.ceil(b64.length*3/4)<=maxBytes) return { base64:b64, mime:'image/jpeg' };
    }
    const ratio=Math.max(0.2, Math.sqrt(maxBytes/(Math.ceil(base64.length*3/4)))*0.92);
    const cw=Math.max(1,Math.round(img.width*ratio));
    const ch=Math.max(1,Math.round(img.height*ratio));
    const c2=document.createElement('canvas'); c2.width=cw; c2.height=ch;
    c2.getContext('2d').drawImage(img,0,0,cw,ch);
    const out2=c2.toDataURL('image/jpeg',0.86);
    return { base64:out2.split(',')[1], mime:'image/jpeg' };
  }

  let ratio=Math.max(0.2, Math.sqrt(maxBytes/(Math.ceil(base64.length*3/4)))*0.95);
  let cw=Math.max(1,Math.round(img.width*ratio));
  let ch=Math.max(1,Math.round(img.height*ratio));
  for(let t=0;t<3;t++){
    const c=document.createElement('canvas'); c.width=cw; c.height=ch;
    c.getContext('2d').drawImage(img,0,0,cw,ch);
    const out=c.toDataURL('image/png');
    const b64=out.split(',')[1];
    if(Math.ceil(b64.length*3/4)<=maxBytes) return { base64:b64, mime:'image/png' };
    cw=Math.max(1,Math.round(cw*0.85));
    ch=Math.max(1,Math.round(ch*0.85));
  }
  const c=document.createElement('canvas'); c.width=cw; c.height=ch;
  c.getContext('2d').drawImage(img,0,0,cw,ch);
  const out=c.toDataURL('image/jpeg',0.86);
  return { base64:out.split(',')[1], mime:'image/jpeg' };
}

// åˆæœŸåŒ–
(async ()=>{

  // â˜…install=1 ã®ã¨ãã ã‘ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€æ¡ˆå†…ã‚’å‡ºã™
  // ï¼ˆrequireKeyã§æ­¢ã¾ã‚‹ã‚±ãƒ¼ã‚¹ã§ã‚‚ã€æ¡ˆå†…ã ã‘ã¯å‡ºã—ãŸã„ã®ã§æœ€åˆã«å‘¼ã¶ï¼‰
  try{ updateInstallGuide_(); }catch(_){}

  // ===== æ›´æ–°ãƒã‚§ãƒƒã‚¯ï¼ˆSWãªã—ã§ç¢ºå®Ÿã«æœ€æ–°ç‰ˆã¸ï¼‰=====
  try{
    const res = await fetch('./version.json?ts=' + Date.now(), { cache: 'no-store' });
    const js  = await res.json();
    const v   = String(js?.v || '');
    if(v){
      const KEY = 'app_version_seen';
      const prev = localStorage.getItem(KEY);

      // æ—¢ã«ä½¿ã£ãŸã“ã¨ãŒã‚ã‚‹ç«¯æœ«ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰ã‚ã£ãŸã‚‰ãƒªãƒ­ãƒ¼ãƒ‰
      if(prev && prev !== v){
        localStorage.setItem(KEY, v);
        location.reload();
        return; // â˜…é‡è¦ï¼šä»¥é™ã®åˆæœŸåŒ–ã‚’æ­¢ã‚ã‚‹
      }
      localStorage.setItem(KEY, v);
    }
  }catch(_){
    // version.json ãŒå–ã‚Œãªã„æ™‚ã¯ç„¡è¦–ã—ã¦ç¶šè¡Œï¼ˆãƒãƒƒãƒˆä¸å®‰å®šã§ã‚‚æ¥­å‹™ã‚’æ­¢ã‚ãªã„ï¼‰
  }

  // ===== ã“ã“ã‹ã‚‰æ—¢å­˜ã®åˆæœŸåŒ– =====
  disableAll(false);

  // éµãŒç„¡ã„å ´åˆã¯ requireKey() ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã—ã¦æ­¢ã‚ã‚‹
  // ï¼ˆinstall=1 ã®æ¡ˆå†…ã¯ä¸Šã§å‡ºã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§returnã—ã¦OKï¼‰
  if(!requireKey()) return;

  render();                 // å…ˆã«ç”»é¢ã‚’æ•´ãˆã‚‹
  setDestLoadingUI_(true);  // é€ä¿¡å…ˆãƒ­ãƒ¼ãƒ‰ä¸­UIï¼‹æ“ä½œãƒ­ãƒƒã‚¯

  loadDestinations()         // awaitã—ãªã„ï¼ˆUIãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
    .then(()=>{
      setDestLoadingUI_(false);
      render();
    })
    .catch(err=>{
      setDestLoadingUI_(false);
      msgBad('é€ä¿¡å…ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é›»æ³¢/URLã‚’ç¢ºèªã—ã¦æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
      console.error(err);
    });

})().catch(err=>{
  msgBad('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  console.error(err);
});


</script>
</body>
</html>















